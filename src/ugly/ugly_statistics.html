<html>

<head>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>

    <script src="js/quizas_auth_helper.js"></script>
</head>

<body>
<h3>Statistics Dummy page</h3>



<b>User ID: </b>
<div id="user_id"></div>
<br/><br/>

<script>
var user_id = quizas_user_id();
$("#user_id").text(user_id);
</script>



<b>Stats of user</b>
<em>/user/#user-id/stats</em><br>
<div id="stats_result"></div>
<br/><br/>

<script>
$(function() {
    $.get("/api/user/" + user_id + "/stats", function (data) {
        $("#stats_result").text(data);

        outputWinLossDrawPieChart(JSON.parse(data));
    });
});
</script>



<b>Stats of user</b>
<em>/user/#user-id/stats/games</em><br>
<div id="stats_games"></div>
<br/><br/>

<script>
$(document).ready(function() {
    // Since we want to use outputStatsForGame,
    // wait for the rest of the page to load.
    $.get("/api/user/" + user_id + "/stats/games", function (data) {
        $("#stats_games").text(data);

        // Call on for-each game.
        var response = JSON.parse(data);
        response.forEach(function (gameId) {
            outputStatsForGame(gameId);
        });
    });
});
</script>



<b>Stats for each Game</b>
<em>/user/#user-id/stats/game/#gameid</em><br>
<div id="stats_for_games"></div>
<br/><br/>

<script>
function outputStatsForGame(gameId) {
    $.get("/api/user/" + user_id + "/stats/game/" + gameId, function (data) {
        var gameDivId = gameId + "_stats";
        
        $("<div/>", {
            "id": gameDivId
        }).appendTo("#stats_for_games");

        $("#" + gameDivId).text(data);

        // Line chart!
        // D3 doesn't like `-` in its IDs!
        // D3 doesn't even fucking like .. numbers?
        var lineGraphId = "ID" + gameId + "gameLineGraph";
        $("<div/>", {
                "id": lineGraphId,
        }).appendTo("#gameLineGraphs");
        outputGameResultsLineChart(lineGraphId, JSON.parse(data));
    });
}
</script>



<b>Stats for each Flashset</b>
<em>/user/#user-id/stats/sets/#setid</em><br>
<div id="stats_for_flashsets"></div>
<br/><br/>

<script>
function quizasId(i) {
    return i.replace(":", "_");
}

function outputStatsForSet(setId) {
    $.get("/api/user/" + user_id + "/stats/sets/" + setId, function (data) {
        // n.b. need to replace : with _
        var setDivId = quizasId(setId) + "_stats";
        
        $("<div/>", {
            "id": setDivId
        }).appendTo("#stats_for_flashsets");

        $("#" + setDivId).text(data);
    });
}

// B/c I'm too lazy to filter through all games
// to find unique flashsets
// I guess best to get all sets; only visualise the ones
// which have been studied.
var flashsetId = "quizlet:57054880";
outputStatsForSet(flashsetId);
</script>

<script>
</script>



<b>Stats for each Friend played against</b>
<em>/user/#user-id/stats/sets/#setid</em><br>
<div id="stats_for_flashsets">
lol, no.
</div>
<br/><br/>



<h2>Graphs</h2>

<!-- Need D3, from CDN; and need d3pie.min.js in the js/ folder.

GitHub is *not* a CDN. But in case you need to know where
to download d3pie.min.js from:
https://raw.githubusercontent.com/benkeen/d3pie/0.1.3/d3pie/d3pie.min.js
-->
<script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.4.4/d3.min.js"></script>
<script src="js/d3pie.min.js"></script>



<div id="overallStatsPieChart"></div>
<br/><br/>

<script>
function outputWinLossDrawPieChart(statsObj) {
    // outputs to "#overallStatsPieChart"
    var numWins = statsObj.wins;
    var numLosses = statsObj.losses;
    var numDraws = statsObj.draws;

    // Yes, you need all these details. Even if you're
    // not going to have subtitles, etc.
    var pieChartData = {
        "header": {
            "title": {
                "text": "Overall Results",
                    "fontSize": 22,
                    "font": "verdana"
            },
            "subtitle": {
                "color": "#999999",
                "fontSize": 10,
                "font": "verdana"
            },
            "titleSubtitlePadding": 12
        },
        "footer": {
            "color": "#999999",
            "fontSize": 11,
            "font": "open sans",
            "location": "bottom-center"
        },
        "size": {
            "canvasHeight": 400,
            "canvasWidth": 590
        },
        "labels": {
            "outer": {
                "pieDistance": 32
            },
            "inner": {
                "format": "value"
            },
            "mainLabel": {
                "font": "verdana"
            },
            "percentage": {
                "color": "#e1e1e1",
                "font": "verdana",
                "decimalPlaces": 0
            },
            "value": {
                "color": "#e1e1e1",
                "font": "verdana"
            },
            "lines": {
                "enabled": true,
                "color": "#cccccc"
            }
        },
        "effects": {
            "load": {
                "effect": "none"
            },
            "pullOutSegmentOnClick": {
                "effect": "none",
                "speed": 400,
                "size": 8
            },
            "highlightSegmentOnMouseover": false
        }
    };

    pieChartData.data = {
        "content": [
        {
            "label": "Wins",
                "value": numWins,
                "color": "#389e38"
        },
        {
            "label": "Draws",
            "value": numLosses,
            "color": "#383838"
        },
        {
            "label": "Losses",
            "value": numDraws,
            "color": "#7c3838"
        }]
    };

    var pie = new d3pie("overallStatsPieChart", pieChartData);
}
</script>



<!-- http://bl.ocks.org/benjchristensen/2579599 -->
<b>Line Chart of a Game</b><br/>
This could be useful for post-game stats.

<div id="gameLineGraphs" class="aGraph" />

<!-- Move to some graph .css or whatever? -->

<style>
/* tell the SVG path to be a thin blue line without any area fill */
#gameLineGraphs .axis {
    shape-rendering: crispEdges;
}

#gameLineGraphs .x.axis line {
    stroke: lightgrey;
}

#gameLineGraphs .x.axis .minor {
    stroke-opacity: .5;
}

#gameLineGraphs .x.axis path {
    display: none;
}

#gameLineGraphs .y.axis line, .y.axis path {
    fill: none;
    stroke: #000;
}
</style>

<script>

function outputGameResultsLineChart(lineGraphId, gameResults) {
    // constraints: two opponents. (gameResults makes this constraint, also).
    var graphWidth = 1000;
    var graphHeight = 400;

    // againstUser : userid
    // result
    // questions : #
    // flashcards:[{ enemy: fcid
    //               question: fcid
    //               ans: fcid }]
    var maxResult = gameResults.questions;

    // implementation adapted from http://bl.ocks.org/benjchristensen/2579599
    // implementation heavily influenced by http://bl.ocks.org/1166403

    // define dimensions of graph
    var m = [80, 80, 80, 80]; // margins
    var w = graphWidth  - m[1] - m[3]; // width
    var h = graphHeight - m[0] - m[2]; // height

    // create a simple data array that we'll plot with a line
    // (this array represents only the Y values,
    //  X will just be the index location)
    var userData = [0];
    var oppoData = [0];

    // Construct data from `gameResults`
    for (var i = 0; i < gameResults.flashcards.length; i += 1) {
        var fc = gameResults.flashcards[i];
        userData.push(fc.question === fc.ans   ? userData[i] + 1 : userData[i]) ;
        oppoData.push(fc.question === fc.enemy ? oppoData[i] + 1 : oppoData[i]) ;
    }

    // X scale will fit all values from data[] within pixels 0-w
    var x = d3.scale.linear().domain([0, userData.length - 1]).range([0, w]);
    // Y scale will fit values from 0-10 within pixels h-0 (Note the inverted domain for the y-scale: bigger is up!)
    var y = d3.scale.linear().domain([0, maxResult]).range([h, 0]);
    // automatically determining max range can work something like this
    // var y = d3.scale.linear().domain([0, d3.max(userData)]).range([h, 0]);

    // create a line function that can convert data[] into x and y points
    var line = d3.svg.line()
    // assign the X function to plot our line as we wish
    .x(function(d,i) {
        // verbose logging to show what's actually being done
        console.log('Plotting X value for data point: ' + d + ' using index: ' + i + ' to be at: ' + x(i) + ' using our xScale.');
        // return the X coordinate where we want to plot this datapoint
        return x(i);
    })
    .y(function(d) {
        // verbose logging to show what's actually being done
        console.log('Plotting Y value for data point: ' + d + ' to be at: ' + y(d) + " using our yScale.");
        // return the Y coordinate where we want to plot this datapoint
        return y(d);
    })

    // Add an SVG element with the desired dimensions and margin.
    var graph = d3.select("#" + lineGraphId).append("svg:svg")
    .attr("width", w + m[1] + m[3])
    .attr("height", h + m[0] + m[2])
    .append("svg:g")
    .attr("transform", "translate(" + m[3] + "," + m[0] + ")");

    // create yAxis
    var xAxis = d3.svg.axis().scale(x).tickSize(-h).tickSubdivide(true);
    // Add the x-axis.
    graph.append("svg:g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + h + ")")
    .call(xAxis);


    // create left yAxis
    var yAxisLeft = d3.svg.axis().scale(y).ticks(4).orient("left");
    // Add the y-axis to the left
    graph.append("svg:g")
    .attr("class", "y axis")
    .attr("transform", "translate(-25,0)")
    .call(yAxisLeft);

    // Add the line by appending an svg:path element with the data line we created above
    // do this AFTER the axes above so that the line is above the tick-lines

    // Possible to set colors & such via CSS, or using `.attr`
    graph.append("svg:path").attr("d", line(userData))
        .attr("stroke", "steelblue")
        .attr("stroke-width", 1)
        .attr("fill", "none");
    graph.append("svg:path").attr("d", line(oppoData))
        .attr("stroke", "red")
        .attr("stroke-width", 1)
        .attr("fill", "none");
}

</script>


</body>

</html>
